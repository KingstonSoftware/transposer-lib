{"version":3,"sources":["../src/Transposer.js"],"names":["escapeRegExp","s","replace","Transposer","constructor","noteRegex","notes","flat","map","sort","a","b","length","join","adornmentRegex","adornments","regex","chordRegex","RegExp","spaceRegex","parse","song","extractChords","chords","m","exec","push","offset","index","name","toString","lines","progression","split","forEach","line","parts","slice","chord","progressionIndex","offsetAfterChord","undefined","type","lastLine","lastLineLength","reduce","sum","part","padEnd","Math","max","beginIndex","endIndex","partIndex","originalKey","_guessKey","stringify","newProgression","newLines","newChord","oldChord","delta","substring","padStart","lineIndex","trimEnd","transpose","newKey","oldKeyScale","scales","key","newKeyScale","normalizeMap","match","indexOf","chordRootArray","accidentals","chordRoot","includes","likelyKey","likelyKeys","firstChord","lastChord","firstLast","VI","iiVI","IVI","IVIV","Vvi","viIV","iiivi","VIByScale","iiVIByScale","IVVIByScale","IVIByScale","IVIVByScale","VviByScale","IVByScale","viIVByScale","iiiviByScale","scale","currentScale","fiveOneHits","iiVIHits","IVVIHits","IVIHits","IVIVHits","VviHits","IVHits","viIVHits","iiiviHits","previousChord","currentChord","nextChord","Object","keys","IVVI","likelyKeyArray","criteria","sortedArray","filter","v","reverse","find","k","IV","likelyKeyMinor","keyCount","minorKeyCount","minor"],"mappings":"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","sourcesContent":["import { scales, normalizeMap, notes, adornments, keys } from \"./data\"\n\nconst escapeRegExp = (s) => s.replace(/[.*+\\-?^${}()|[\\]\\\\]/g, \"\\\\$&\") // $& means the whole matched string\n\nexport class Transposer {\n  constructor() {\n    const noteRegex = notes\n      .flat()\n      .map(escapeRegExp)\n      .sort((a, b) => a.length - b.length)\n      .join(\"|\")\n    const adornmentRegex = adornments\n      .flat()\n      .map(escapeRegExp)\n      .sort((a, b) => a.length - b.length)\n      .join(\"|\")\n    const regex =\n      \"(?!A [a-z])(?<=^| |\\\\t)(?:\" +\n      noteRegex +\n      \")(?:\" +\n      adornmentRegex +\n      \")?(?= |\\\\t|$)\"\n\n    this.chordRegex = new RegExp(regex, \"g\")\n    this.spaceRegex = new RegExp(\"^[ \\t\\n]*$\")\n  }\n\n  /*\n  Parse a song with chords generating:\n\n  - The lines of the song\n  - The entire chord progression for the song\n  - The unique chords used in the song\n  - Guessing the key the song is in\n\n  Songs should be displayed in a fix pitch font.\n\n  We parse 4 types of song lines:\n\n  chords  | lines mixed chords and text\n  lyrics  | lines with only text and chords above\n  other   | lines with no chords\n  */\n  parse(song) {\n    const extractChords = (s) => {\n      const chords = []\n      let m\n\n      while ((m = this.chordRegex.exec(s)) !== null) {\n        chords.push({ offset: m.index, name: m.toString() })\n      }\n\n      return chords\n    }\n    const lines = []\n    const progression = []\n\n    song.split(/\\r?\\n/gm).forEach((line) => {\n      const chords = extractChords(line)\n\n      if (chords.length > 0) {\n        const parts = []\n\n        if (chords[0].offset > 0) {\n          parts.push([null, line.slice(0, chords[0].offset)])\n        }\n\n        chords.forEach((chord, index) => {\n          progression.push(chord.name)\n\n          const progressionIndex = progression.length - 1\n          const offsetAfterChord = chord.offset + chord.name.length\n\n          parts.push([\n            progressionIndex,\n            line.slice(\n              offsetAfterChord,\n              index === chords.length - 1 ? undefined : chords[index + 1].offset\n            ),\n          ])\n        })\n\n        lines.push({ type: \"chords\", parts })\n        return\n      }\n\n      const lastLine = lines.length > 0 ? lines[lines.length - 1] : null\n\n      if (lastLine && lastLine.type === \"chords\") {\n        const lastLineLength = lastLine.parts.reduce(\n          (sum, part) =>\n            sum +\n            (part[0] !== null ? progression[part[0]].length : 0) +\n            part[1].length,\n          0\n        )\n\n        line = line.padEnd(Math.max(line.length, lastLineLength))\n\n        const parts = []\n        let beginIndex = 0\n        let endIndex = 0\n\n        // Chop line up into same number of parts as the chords array in the last line\n        lastLine.parts.forEach((part, partIndex) => {\n          if (partIndex === lastLine.parts.length - 1) {\n            parts.push(line.slice(beginIndex))\n          } else {\n            if (part[0] !== null) {\n              endIndex += progression[part[0]].length\n            }\n\n            endIndex += part[1].length\n            parts.push(line.slice(beginIndex, endIndex))\n            beginIndex = endIndex\n          }\n        })\n\n        lines.push({ type: \"lyrics\", parts })\n        return\n      }\n\n      lines.push({ type: \"other\", parts: [line] })\n    })\n\n    this.lines = lines\n    this.progression = progression\n    this.originalKey = this._guessKey()\n  }\n\n  stringify(newProgression) {\n    newProgression = newProgression ?? this.progression\n\n    let newLines = this.lines.map((line) =>\n      line.type === \"other\"\n        ? line.parts[0]\n        : line.type === \"chords\"\n        ? {\n            type: \"chords\",\n            parts: line.parts.map((part) => {\n              if (part[0] === null) {\n                return part[1]\n              }\n\n              const newChord = newProgression[part[0]]\n              const oldChord = this.progression[part[0]]\n              const delta = newChord.length - oldChord.length\n              let s = part[1]\n\n              if (delta > 0) {\n                // Leave at least one space between chords\n                if (s.length > 1) {\n                  s = s.substring(delta)\n                } else {\n                  s = s.padStart(delta + s.length - 1)\n                }\n              } else if (delta < 0) {\n                s = s.padStart(s.length - delta)\n              }\n\n              return newChord + s\n            }),\n          }\n        : line\n    )\n\n    newLines = newLines.map((line, lineIndex) =>\n      line.type === \"lyrics\"\n        ? line.parts\n            .map((part, partIndex) =>\n              part.padEnd(\n                Math.max(\n                  part.length,\n                  newLines[lineIndex - 1].parts[partIndex].length\n                )\n              )\n            )\n            .join(\"\")\n            .trimEnd()\n        : line\n    )\n\n    newLines = newLines\n      .map((line) =>\n        line.type === \"chords\" ? line.parts.join(\"\").trimEnd() : line\n      )\n      .join(\"\\n\")\n\n    return newLines\n  }\n\n  transpose(newKey) {\n    let oldKeyScale = scales[this.key + \"Scale\"]\n    let newKeyScale = scales[newKey + \"Scale\"]\n\n    if (!oldKeyScale) {\n      oldKeyScale = scales[`${normalizeMap[key]}Scale`]\n    }\n\n    const newProgression = progression.map((chord) =>\n      chord.replace(\n        /(([CDEFGAB]#\\*)|([CDEFGAB]#)|([CDEFGAB]b+)|([CDEFGAB]\\**))/g,\n        (match) => newKeyScale[oldKeyScale.indexOf(match)]\n      )\n    )\n\n    return newProgression\n  }\n\n  _guessKey() {\n    // before anything, process away everything that is not the root of the chord for root analysis\n    const chordRootArray = this.progression.map((chord) => {\n      const accidentals = [\"#\", \"b\", \"*\", \"bb\", \"bbb\"]\n      let chordRoot = \"\"\n\n      if (chord.length > 1) {\n        if (chord.substring(1, 3) === \"bb\") {\n          chordRoot = chord.substring(0, 3)\n        } else {\n          if (chord.substring(1, 4) === \"bbb\") {\n            chordRoot = chord.substring(0, 4)\n          }\n\n          if (!accidentals.includes(chord[1])) {\n            chordRoot = chord[0]\n          } else {\n            chordRoot = chord.substring(0, 2)\n          }\n        }\n      } else {\n        chordRoot = chord[0]\n      }\n      return chordRoot\n    })\n\n    let likelyKey = \"\"\n    let likelyKeys = {\n      firstChord: chordRootArray[0],\n      lastChord: chordRootArray[chordRootArray.length - 1],\n      firstLast: null,\n      VI: null,\n      iiVI: null,\n      IVI: null,\n      IVIV: null,\n      Vvi: null,\n      viIV: null,\n      iiivi: null,\n    }\n\n    // also in preprocessing, clean the chords of anything that's not a qualifier if you want to do circle of 5 analysis\n    // first, check if first and last chord are the same. High likelihood this is the key\n    if (chordRootArray[0] === chordRootArray[chordRootArray.length - 1]) {\n      likelyKeys.firstLast = chordRootArray[0]\n    }\n\n    // next, look for V-I... for all keys\n    let VIByScale = {}\n    let iiVIByScale = {}\n    let IVVIByScale = {}\n    let IVIByScale = {}\n    let IVIVByScale = {}\n    let VviByScale = {}\n    let IVByScale = {}\n    let viIVByScale = {}\n    let iiiviByScale = {}\n\n    for (const scale in scales) {\n      const currentScale = scales[scale]\n      // for each scale\n      let fiveOneHits = 0\n      let iiVIHits = 0\n      let IVVIHits = 0\n      let IVIHits = 0\n      let IVIVHits = 0\n      let VviHits = 0\n      let IVHits = 0\n      let viIVHits = 0\n      let iiiviHits = 0\n      chordRootArray.forEach((chord, index) => {\n        if (index === chordRootArray.length - 1) {\n          // last chord\n          return\n        }\n\n        // look at each set of 2 chords\n        const previousChord = index === 0 ? null : chordRootArray[index - 1]\n        const currentChord = chord\n        const nextChord = chordRootArray[index + 1]\n        if (currentScale[4] === currentChord && currentScale[0] === nextChord) {\n          // it is a V-I in this key\n          fiveOneHits++\n\n          if (previousChord) {\n            // check for ii-V-I\n            if (previousChord === currentScale[1]) {\n              iiVIHits++\n            }\n            if (previousChord === currentScale[3]) {\n              IVVIHits++\n            }\n          }\n        }\n        // check IV-I\n        if (currentScale[3] === currentChord && currentScale[0] === nextChord) {\n          IVIHits++\n          if (chordRootArray[index + 2]) {\n            if (currentScale[4] === chordRootArray[index + 2]) {\n              IVIVHits++\n            }\n          }\n        }\n        // check V - vi\n        if (currentScale[4] === currentChord && currentScale[5] === nextChord) {\n          VviHits++\n        }\n        // check I-V\n        if (currentScale[0] === currentChord && currentScale[4] === nextChord) {\n          IVHits++\n        }\n        // check vi-IV\n        if (currentScale[5] === currentChord && currentScale[3] === nextChord) {\n          viIVHits++\n        }\n        // check iii-vi\n        if (currentScale[2] === currentChord && currentScale[5] === nextChord) {\n          iiiviHits++\n        }\n      })\n      VIByScale[scale] = fiveOneHits\n      iiVIByScale[scale] = iiVIHits\n      IVVIByScale[scale] = IVVIHits\n      IVIByScale[scale] = IVIHits\n      IVIVByScale[scale] = IVIVHits\n      VviByScale[scale] = VviHits\n      IVByScale[scale] = IVHits\n      viIVByScale[scale] = viIVHits\n      iiiviByScale[scale] = iiiviHits\n    }\n\n    likelyKeys.VI = Object.keys(VIByScale)\n      .reduce((a, b) => (VIByScale[a] > VIByScale[b] ? a : b))\n      .replace(\"Scale\", \"\")\n\n    if (likelyKeys.VI === \"test\") {\n      likelyKeys.VI = null\n    }\n    likelyKeys.iiVI = Object.keys(iiVIByScale)\n      .reduce((a, b) => (iiVIByScale[a] > iiVIByScale[b] ? a : b))\n      .replace(\"Scale\", \"\")\n\n    if (likelyKeys.iiVI === \"test\") {\n      likelyKeys.iiVI = null\n    }\n    likelyKeys.IVI = Object.keys(IVIByScale)\n      .reduce((a, b) => (IVIByScale[a] > IVIByScale[b] ? a : b))\n      .replace(\"Scale\", \"\")\n\n    if (likelyKeys.IVI === \"test\") {\n      likelyKeys.IVI = null\n    }\n    likelyKeys.IVIV = Object.keys(IVIVByScale)\n      .reduce((a, b) => (IVIVByScale[a] > IVIVByScale[b] ? a : b))\n      .replace(\"Scale\", \"\")\n\n    if (likelyKeys.IVIV === \"test\") {\n      likelyKeys.IVIV = null\n    }\n    likelyKeys.Vvi = Object.keys(VviByScale)\n      .reduce((a, b) => (VviByScale[a] > VviByScale[b] ? a : b))\n      .replace(\"Scale\", \"\")\n\n    if (likelyKeys.Vvi === \"test\") {\n      likelyKeys.Vvi = null\n    }\n\n    likelyKeys.IVVI = Object.keys(IVVIByScale)\n      .reduce((a, b) => (IVVIByScale[a] > IVVIByScale[b] ? a : b))\n      .replace(\"Scale\", \"\")\n\n    if (likelyKeys.IVVI === \"test\") {\n      likelyKeys.IVVI = null\n    }\n\n    likelyKeys.viIV = Object.keys(viIVByScale)\n      .reduce((a, b) => (viIVByScale[a] > viIVByScale[b] ? a : b))\n      .replace(\"Scale\", \"\")\n\n    if (likelyKeys.viIV === \"test\") {\n      likelyKeys.viIV = null\n    }\n\n    likelyKeys.iiivi = Object.keys(iiiviByScale)\n      .reduce((a, b) => (iiiviByScale[a] > iiiviByScale[b] ? a : b))\n      .replace(\"Scale\", \"\")\n\n    if (likelyKeys.iiivi === \"test\") {\n      likelyKeys.iiivi = null\n    }\n\n    // if firstLast and VI are the same key, we definitely have a winner\n    if (\n      likelyKeys.firstLast !== null &&\n      likelyKeys.firstLast === likelyKeys.VI\n    ) {\n      likelyKey = likelyKeys.firstLast\n    } else {\n      // check all the likelyKeys and see which appears most frequently\n      const likelyKeyArray = Object.keys(likelyKeys).map((criteria) => {\n        return likelyKeys[criteria]\n      })\n\n      let sortedArray = likelyKeyArray\n        .sort(\n          (a, b) =>\n            likelyKeyArray.filter((v) => v === a).length -\n            likelyKeyArray.filter((v) => v === b).length\n        )\n        .reverse()\n      likelyKey = sortedArray.find((k) => {\n        return k !== null\n      })\n    }\n\n    // if there are no standard chord movements to check, we should default to the first chord I think\n    if (\n      !likelyKeys.VI &&\n      !likelyKeys.iiVI &&\n      !likelyKeys.IVVI &&\n      !likelyKeys.IVI &&\n      !likelyKeys.Vvi &&\n      !likelyKeys.IV &&\n      !likelyKeys.viIV &&\n      !likelyKeys.iiivi\n    ) {\n      likelyKey = likelyKeys.firstChord\n    }\n\n    // finally, check if likely key in minor or major form appears more frequently\n    // as this solution develops, this is less and less likely, as the relative major will be\n    // returned more often than not (which is great, as far as i'm concerned)\n    const likelyKeyMinor = `${likelyKey}m`\n    const keyCount = this.progression.filter((chord) => {\n      return (\n        chord.substring(0, likelyKey.length) === likelyKey &&\n        chord.substring(likelyKey.length, likelyKey.length + 1) !== \"m\"\n      )\n    })\n    const minorKeyCount = this.progression.filter((chord) => {\n      return (\n        chord.substring(0, likelyKeyMinor.length) === likelyKeyMinor &&\n        chord.substring(likelyKey.length, 4) !== \"maj\"\n      )\n    })\n\n    return keyCount.length >= minorKeyCount.length\n      ? likelyKey\n      : keys.find((k) => {\n          return k.minor === likelyKeyMinor\n        })?.key || likelyKey\n  }\n}\n"],"file":"Transposer.js"}